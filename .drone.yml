workspace:
  base: /go
  path: src/github.com/UCCNetworkingSociety/Netsoc-Discord-Bot

pipeline:
  unit_tests:
    image: golang:latest
    commands:
      - bash -c "if [[ \$(gofmt -l *.go) ]]; then gofmt -l *.go; exit 1; fi"
      - go get -t ./...
      - go test ./...

  build_push_latest:
    group: build_group
    image: plugins/docker
    tags: latest
    dockerfile: Dockerfile
    repo: docker.netsoc.co/netsoc-discord-bot
    registry: docker.netsoc.co
    secrets: [ docker_username, docker_password ]
    when:
      branch: master
      event:
        exclude: [ pull_request ]

  build_push_other:
    group: build_group
    image: plugins/docker
    tags: ${DRONE_COMMIT_BRANCH}
    dockerfile: Dockerfile
    repo: docker.netsoc.co/netsoc-discord-bot
    registry: docker.netsoc.co
    secrets: [ docker_username, docker_password ]
    when:
      branch:
        exclude: [ master ]
